<div class="step-content">
    <h4><i class="fas fa-brain me-2"></i>B∆∞·ªõc 2: C·∫•u h√¨nh AI Provider</h4>
    <p class="text-muted">Ch·ªçn v√† thi·∫øt l·∫≠p AI provider ƒë·ªÉ bot c√≥ th·ªÉ tr·∫£ l·ªùi th√¥ng minh</p>
    
    <form id="openrouter-form">
        <!-- AI Provider Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-robot me-1"></i><strong>Ch·ªçn AI Provider</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <label for="ai_provider" class="form-label">
                            <i class="fas fa-brain me-1"></i>AI Provider *
                        </label>
                        <select class="form-select" id="ai_provider" name="ai_provider" required>
                            <option value="openrouter" {{ 'selected' if config.get('openrouter', {}).get('provider', 'openrouter') == 'openrouter' else '' }}>
                                üåü OpenRouter (Khuy·∫øn ngh·ªã) - 100+ AI models, gi√° r·∫ª
                            </option>
                            <option value="openai" {{ 'selected' if config.get('openrouter', {}).get('provider') == 'openai' else '' }}>
                                ü§ñ OpenAI - GPT-4o, GPT-4, GPT-3.5 (tr·ª±c ti·∫øp)
                            </option>
                            <option value="anthropic" {{ 'selected' if config.get('openrouter', {}).get('provider') == 'anthropic' else '' }}>
                                üß† Anthropic - Claude 3.5, Claude 3 (tr·ª±c ti·∫øp)
                            </option>
                            <option value="google" {{ 'selected' if config.get('openrouter', {}).get('provider') == 'google' else '' }}>
                                üîç Google - Gemini 1.5 Pro/Flash (tr·ª±c ti·∫øp)
                            </option>
                            <option value="grok" {{ 'selected' if config.get('openrouter', {}).get('provider') == 'grok' else '' }}>
                                üöÄ Grok (X.AI) - Grok Beta (tr·ª±c ti·∫øp)
                            </option>
                            <option value="deepseek" {{ 'selected' if config.get('openrouter', {}).get('provider') == 'deepseek' else '' }}>
                                üî¨ DeepSeek - DeepSeek Chat (tr·ª±c ti·∫øp)
                            </option>
                            <option value="huggingface" {{ 'selected' if config.get('openrouter', {}).get('provider') == 'huggingface' else '' }}>
                                ü§ó HuggingFace - Open Source Models
                            </option>
                            <option value="local" {{ 'selected' if config.get('openrouter', {}).get('provider') == 'local' else '' }}>
                                üè† Local AI - Ollama, LM Studio
                            </option>
                        </select>
                        <div class="form-text">
                            <strong>OpenRouter</strong> ƒë∆∞·ª£c khuy·∫øn ngh·ªã v√¨ h·ªó tr·ª£ nhi·ªÅu AI models v·ªõi gi√° c·∫£ h·ª£p l√Ω
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OpenRouter Configuration (Default) -->
        <div class="provider-config" id="openrouter-config">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>OpenRouter Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="openrouter_api_key" class="form-label">
                                    <i class="fas fa-key me-1"></i>OpenRouter API Key *
                                </label>
                                <input type="password" class="form-control" id="api_key" name="api_key"
                                       value="{{ config.get('openrouter', {}).get('api_key', '') }}"
                                       placeholder="sk-or-v1-..." required>
                                <div class="form-text">API key t·ª´ <a href="https://openrouter.ai/keys" target="_blank">OpenRouter.ai</a></div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="openrouter_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>AI Model
                                    <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="loadDynamicModels()">
                                        <i class="fas fa-sync-alt"></i> Load Latest
                                    </button>
                                </label>
                                <select class="form-select" id="model" name="model">
                                    <!-- Loading placeholder -->
                                    <option value="">Loading models...</option>

                                    <!-- Fallback Free Models (in case API fails) -->
                                    <optgroup label="üÜì Free Models (Fallback)" id="fallback-free-models" style="display: none;">
                                        <option value="meta-llama/llama-3.1-8b-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.1-8b-instruct:free' else '' }}>
                                            Llama 3.1 8B Instruct
                                        </option>
                                        <option value="meta-llama/llama-3.1-70b-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.1-70b-instruct:free' else '' }}>
                                            Llama 3.1 70B Instruct
                                        </option>
                                        <option value="meta-llama/llama-3.2-3b-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.2-3b-instruct:free' else '' }}>
                                            Llama 3.2 3B Instruct
                                        </option>
                                        <option value="meta-llama/llama-3.2-1b-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.2-1b-instruct:free' else '' }}>
                                            Llama 3.2 1B Instruct
                                        </option>
                                        <option value="microsoft/phi-3-mini-128k-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'microsoft/phi-3-mini-128k-instruct:free' else '' }}>
                                            Phi-3 Mini 128K
                                        </option>
                                        <option value="microsoft/phi-3-medium-128k-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'microsoft/phi-3-medium-128k-instruct:free' else '' }}>
                                            Phi-3 Medium 128K
                                        </option>
                                        <option value="google/gemma-2-9b-it:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'google/gemma-2-9b-it:free' else '' }}>
                                            Gemma 2 9B IT
                                        </option>
                                        <option value="google/gemma-2-27b-it:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'google/gemma-2-27b-it:free' else '' }}>
                                            Gemma 2 27B IT
                                        </option>
                                        <option value="mistralai/mistral-7b-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'mistralai/mistral-7b-instruct:free' else '' }}>
                                            Mistral 7B Instruct
                                        </option>
                                        <option value="huggingfaceh4/zephyr-7b-beta:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'huggingfaceh4/zephyr-7b-beta:free' else '' }}>
                                            Zephyr 7B Beta
                                        </option>
                                        <option value="deepseek/deepseek-chat:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'deepseek/deepseek-chat:free' else '' }}>
                                            DeepSeek Chat (Free)
                                        </option>
                                        <option value="deepseek/deepseek-prover-v2:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'deepseek/deepseek-prover-v2:free' else '' }}>
                                            DeepSeek Prover V2 (Free)
                                        </option>
                                        <option value="qwen/qwen-2.5-7b-instruct:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'qwen/qwen-2.5-7b-instruct:free' else '' }}>
                                            Qwen 2.5 7B Instruct
                                        </option>
                                        <option value="openchat/openchat-7b:free"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openchat/openchat-7b:free' else '' }}>
                                            OpenChat 7B
                                        </option>
                                    </optgroup>

                                    <!-- OpenAI Models -->
                                    <optgroup label="ü§ñ OpenAI Models">
                                        <option value="openai/gpt-3.5-turbo"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openai/gpt-3.5-turbo' else '' }}>
                                            GPT-3.5 Turbo ($0.50/$1.50)
                                        </option>
                                        <option value="openai/gpt-4"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openai/gpt-4' else '' }}>
                                            GPT-4 ($30/$60)
                                        </option>
                                        <option value="openai/gpt-4-turbo"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openai/gpt-4-turbo' else '' }}>
                                            GPT-4 Turbo ($10/$30)
                                        </option>
                                        <option value="openai/gpt-4o"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openai/gpt-4o' else '' }}>
                                            GPT-4o ($5/$15)
                                        </option>
                                        <option value="openai/gpt-4o-mini"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openai/gpt-4o-mini' else '' }}>
                                            GPT-4o Mini ($0.15/$0.60)
                                        </option>
                                    </optgroup>

                                    <!-- Anthropic Models -->
                                    <optgroup label="üß† Anthropic Models">
                                        <option value="anthropic/claude-3-haiku"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'anthropic/claude-3-haiku' else '' }}>
                                            Claude 3 Haiku ($0.25/$1.25)
                                        </option>
                                        <option value="anthropic/claude-3-sonnet"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'anthropic/claude-3-sonnet' else '' }}>
                                            Claude 3 Sonnet ($3/$15)
                                        </option>
                                        <option value="anthropic/claude-3-opus"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'anthropic/claude-3-opus' else '' }}>
                                            Claude 3 Opus ($15/$75)
                                        </option>
                                        <option value="anthropic/claude-3.5-sonnet"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'anthropic/claude-3.5-sonnet' else '' }}>
                                            Claude 3.5 Sonnet ($3/$15)
                                        </option>
                                    </optgroup>

                                    <!-- Google Models -->
                                    <optgroup label="üîç Google Models">
                                        <option value="google/gemini-pro"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'google/gemini-pro' else '' }}>
                                            Gemini Pro ($0.50/$1.50)
                                        </option>
                                        <option value="google/gemini-pro-vision"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'google/gemini-pro-vision' else '' }}>
                                            Gemini Pro Vision ($0.50/$1.50)
                                        </option>
                                        <option value="google/gemini-flash-1.5"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'google/gemini-flash-1.5' else '' }}>
                                            Gemini 1.5 Flash ($0.075/$0.30)
                                        </option>
                                    </optgroup>

                                    <!-- DeepSeek Models -->
                                    <optgroup label="üî¨ DeepSeek Models">
                                        <option value="deepseek/deepseek-chat"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'deepseek/deepseek-chat' else '' }}>
                                            DeepSeek Chat ($0.14/$0.28)
                                        </option>
                                        <option value="deepseek/deepseek-chat-v3-0324"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'deepseek/deepseek-chat-v3-0324' else '' }}>
                                            DeepSeek Chat V3 0324 ($0.14/$0.28)
                                        </option>
                                        <option value="deepseek/deepseek-prover-v2"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'deepseek/deepseek-prover-v2' else '' }}>
                                            DeepSeek Prover V2 ($0.14/$0.28)
                                        </option>
                                        <option value="deepseek/deepseek-r1"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'deepseek/deepseek-r1' else '' }}>
                                            DeepSeek R1 ($0.55/$2.19)
                                        </option>
                                        <option value="deepseek/deepseek-r1-0528"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'deepseek/deepseek-r1-0528' else '' }}>
                                            DeepSeek R1 0528 ($0.55/$2.19)
                                        </option>
                                    </optgroup>

                                    <!-- Cohere Models -->
                                    <optgroup label="üåä Cohere Models">
                                        <option value="cohere/command-r-plus"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'cohere/command-r-plus' else '' }}>
                                            Command R+ ($3/$15)
                                        </option>
                                        <option value="cohere/command-r7b-12-2024"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'cohere/command-r7b-12-2024' else '' }}>
                                            Command R7B 12-2024 ($0.30/$1.50)
                                        </option>
                                        <option value="cohere/command-r"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'cohere/command-r' else '' }}>
                                            Command R ($0.50/$1.50)
                                        </option>
                                    </optgroup>

                                    <!-- Qwen Models -->
                                    <optgroup label="üéØ Qwen Models">
                                        <option value="qwen/qwen-2.5-72b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'qwen/qwen-2.5-72b-instruct' else '' }}>
                                            Qwen 2.5 72B Instruct ($0.40/$1.20)
                                        </option>
                                        <option value="qwen/qwen-2.5-32b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'qwen/qwen-2.5-32b-instruct' else '' }}>
                                            Qwen 2.5 32B Instruct ($0.30/$0.90)
                                        </option>
                                        <option value="qwen/qwen-2.5-14b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'qwen/qwen-2.5-14b-instruct' else '' }}>
                                            Qwen 2.5 14B Instruct ($0.20/$0.60)
                                        </option>
                                        <option value="qwen/qwen-2.5-7b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'qwen/qwen-2.5-7b-instruct' else '' }}>
                                            Qwen 2.5 7B Instruct ($0.07/$0.21)
                                        </option>
                                    </optgroup>

                                    <!-- Other Popular Models -->
                                    <optgroup label="üåü Other Popular Models">
                                        <option value="perplexity/llama-3.1-sonar-large-128k-online"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'perplexity/llama-3.1-sonar-large-128k-online' else '' }}>
                                            Perplexity Sonar Large (Online) ($5/$5)
                                        </option>
                                        <option value="x-ai/grok-beta"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'x-ai/grok-beta' else '' }}>
                                            Grok Beta ($5/$15)
                                        </option>
                                        <option value="nvidia/llama-3.1-nemotron-70b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'nvidia/llama-3.1-nemotron-70b-instruct' else '' }}>
                                            Llama 3.1 Nemotron 70B ($0.35/$0.40)
                                        </option>
                                        <option value="liquid/lfm-40b"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'liquid/lfm-40b' else '' }}>
                                            Liquid LFM 40B ($0.25/$0.25)
                                        </option>
                                    </optgroup>

                                    <!-- Mistral Models -->
                                    <optgroup label="üå™Ô∏è Mistral Models">
                                        <option value="mistralai/mistral-large"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'mistralai/mistral-large' else '' }}>
                                            Mistral Large ($3/$9)
                                        </option>
                                        <option value="mistralai/mistral-medium"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'mistralai/mistral-medium' else '' }}>
                                            Mistral Medium ($2.70/$8.10)
                                        </option>
                                        <option value="mistralai/mistral-small"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'mistralai/mistral-small' else '' }}>
                                            Mistral Small ($1/$3)
                                        </option>
                                        <option value="mistralai/mistral-nemo"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'mistralai/mistral-nemo' else '' }}>
                                            Mistral Nemo ($0.18/$0.18)
                                        </option>
                                        <option value="mistralai/codestral-mamba"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'mistralai/codestral-mamba' else '' }}>
                                            Codestral Mamba ($0.25/$0.25)
                                        </option>
                                    </optgroup>

                                    <!-- Meta Llama Models -->
                                    <optgroup label="ü¶ô Meta Llama Models">
                                        <option value="meta-llama/llama-3.1-405b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.1-405b-instruct' else '' }}>
                                            Llama 3.1 405B Instruct ($3/$3)
                                        </option>
                                        <option value="meta-llama/llama-3.1-70b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.1-70b-instruct' else '' }}>
                                            Llama 3.1 70B Instruct ($0.35/$0.40)
                                        </option>
                                        <option value="meta-llama/llama-3.1-8b-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.1-8b-instruct' else '' }}>
                                            Llama 3.1 8B Instruct ($0.06/$0.06)
                                        </option>
                                        <option value="meta-llama/llama-3.2-90b-vision-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.2-90b-vision-instruct' else '' }}>
                                            Llama 3.2 90B Vision ($0.90/$0.90)
                                        </option>
                                        <option value="meta-llama/llama-3.2-11b-vision-instruct"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'meta-llama/llama-3.2-11b-vision-instruct' else '' }}>
                                            Llama 3.2 11B Vision ($0.055/$0.055)
                                        </option>
                                    </optgroup>

                                    <!-- Specialized Models -->
                                    <optgroup label="üéØ Specialized Models">
                                        <option value="openai/o1-preview"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openai/o1-preview' else '' }}>
                                            OpenAI o1 Preview ($15/$60)
                                        </option>
                                        <option value="openai/o1-mini"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'openai/o1-mini' else '' }}>
                                            OpenAI o1 Mini ($3/$12)
                                        </option>
                                        <option value="anthropic/claude-3.5-sonnet-20241022"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'anthropic/claude-3.5-sonnet-20241022' else '' }}>
                                            Claude 3.5 Sonnet (Latest) ($3/$15)
                                        </option>
                                        <option value="google/gemini-flash-1.5-8b"
                                                {{ 'selected' if config.get('openrouter', {}).get('model') == 'google/gemini-flash-1.5-8b' else '' }}>
                                            Gemini Flash 1.5 8B ($0.0375/$0.15)
                                        </option>
                                    </optgroup>
                                </select>
                                <div class="form-text">Ch·ªçn AI model ƒë·ªÉ s·ª≠ d·ª•ng</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enabled" name="enabled"
                                       {{ 'checked' if config.get('openrouter', {}).get('enabled', True) != false else '' }}>
                                <label class="form-check-label" for="enabled">
                                    K√≠ch ho·∫°t OpenRouter AI
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other Provider Configurations (Hidden by default) -->
        <div class="provider-config" id="openai-config" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>OpenAI Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="openai_api_key" class="form-label">
                                    <i class="fas fa-key me-1"></i>OpenAI API Key *
                                </label>
                                <input type="password" class="form-control" id="openai_api_key" name="openai_api_key"
                                       placeholder="sk-..." required>
                                <div class="form-text">API key t·ª´ <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="openai_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>OpenAI Model
                                </label>
                                <select class="form-select" id="openai_model" name="openai_model">
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo ($0.50/$1.50 per 1M tokens)</option>
                                    <option value="gpt-4">GPT-4 ($30/$60 per 1M tokens)</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo ($10/$30 per 1M tokens)</option>
                                    <option value="gpt-4o">GPT-4o ($5/$15 per 1M tokens)</option>
                                    <option value="gpt-4o-mini">GPT-4o Mini ($0.15/$0.60 per 1M tokens)</option>
                                    <option value="gpt-4-1106-preview">GPT-4 Turbo Preview ($10/$30 per 1M tokens)</option>
                                    <option value="gpt-3.5-turbo-16k">GPT-3.5 Turbo 16K ($3/$4 per 1M tokens)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="provider-config" id="anthropic-config" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>Anthropic Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="anthropic_api_key" class="form-label">
                                    <i class="fas fa-key me-1"></i>Anthropic API Key *
                                </label>
                                <input type="password" class="form-control" id="anthropic_api_key" name="anthropic_api_key"
                                       placeholder="sk-ant-..." required>
                                <div class="form-text">API key t·ª´ <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="anthropic_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>Claude Model
                                </label>
                                <select class="form-select" id="anthropic_model" name="anthropic_model">
                                    <option value="claude-3-haiku-20240307">Claude 3 Haiku ($0.25/$1.25 per 1M tokens)</option>
                                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet ($3/$15 per 1M tokens)</option>
                                    <option value="claude-3-opus-20240229">Claude 3 Opus ($15/$75 per 1M tokens)</option>
                                    <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet ($3/$15 per 1M tokens)</option>
                                    <option value="claude-2.1">Claude 2.1 ($8/$24 per 1M tokens)</option>
                                    <option value="claude-2.0">Claude 2.0 ($8/$24 per 1M tokens)</option>
                                    <option value="claude-instant-1.2">Claude Instant 1.2 ($0.80/$2.40 per 1M tokens)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="provider-config" id="google-config" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>Google AI Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="google_api_key" class="form-label">
                                    <i class="fas fa-key me-1"></i>Google AI API Key *
                                </label>
                                <input type="password" class="form-control" id="google_api_key" name="google_api_key"
                                       placeholder="AIza..." required>
                                <div class="form-text">API key t·ª´ <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="google_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>Gemini Model
                                </label>
                                <select class="form-select" id="google_model" name="google_model">
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (Latest)</option>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast & Efficient)</option>
                                    <option value="gemini-pro">Gemini Pro (Stable)</option>
                                    <option value="gemini-pro-vision">Gemini Pro Vision (Multimodal)</option>
                                    <option value="gemini-1.0-pro">Gemini 1.0 Pro (Legacy)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="provider-config" id="grok-config" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>Grok (X.AI) Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="grok_api_key" class="form-label">
                                    <i class="fas fa-key me-1"></i>Grok API Key *
                                </label>
                                <input type="password" class="form-control" id="grok_api_key" name="grok_api_key"
                                       placeholder="xai-..." required>
                                <div class="form-text">API key t·ª´ <a href="https://console.x.ai/" target="_blank">X.AI Console</a></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="grok_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>Grok Model
                                </label>
                                <select class="form-select" id="grok_model" name="grok_model">
                                    <option value="grok-beta">Grok Beta (Latest)</option>
                                    <option value="grok-vision-beta">Grok Vision Beta (Multimodal)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="provider-config" id="deepseek-config" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>DeepSeek Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="deepseek_api_key" class="form-label">
                                    <i class="fas fa-key me-1"></i>DeepSeek API Key *
                                </label>
                                <input type="password" class="form-control" id="deepseek_api_key" name="deepseek_api_key"
                                       placeholder="sk-..." required>
                                <div class="form-text">API key t·ª´ <a href="https://platform.deepseek.com/" target="_blank">DeepSeek Platform</a></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="deepseek_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>DeepSeek Model
                                </label>
                                <select class="form-select" id="deepseek_model" name="deepseek_model">
                                    <option value="deepseek-chat">DeepSeek Chat (Latest)</option>
                                    <option value="deepseek-coder">DeepSeek Coder (Code Specialist)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="provider-config" id="huggingface-config" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>HuggingFace Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="huggingface_api_key" class="form-label">
                                    <i class="fas fa-key me-1"></i>HuggingFace API Token *
                                </label>
                                <input type="password" class="form-control" id="huggingface_api_key" name="huggingface_api_key"
                                       placeholder="hf_..." required>
                                <div class="form-text">API token t·ª´ <a href="https://huggingface.co/settings/tokens" target="_blank">HuggingFace Settings</a></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="huggingface_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>HuggingFace Model
                                </label>
                                <select class="form-select" id="huggingface_model" name="huggingface_model">
                                    <option value="microsoft/DialoGPT-medium">DialoGPT Medium</option>
                                    <option value="facebook/blenderbot-400M-distill">BlenderBot 400M</option>
                                    <option value="microsoft/DialoGPT-large">DialoGPT Large</option>
                                    <option value="huggingface/CodeBERTa-small-v1">CodeBERTa Small</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="provider-config" id="local-config" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog me-1"></i><strong>Local AI Configuration</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="local_endpoint" class="form-label">
                                    <i class="fas fa-server me-1"></i>Local AI Endpoint *
                                </label>
                                <input type="url" class="form-control" id="local_endpoint" name="local_endpoint"
                                       placeholder="http://localhost:11434" required>
                                <div class="form-text">URL c·ªßa Ollama ho·∫∑c LM Studio server</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="local_model" class="form-label">
                                    <i class="fas fa-robot me-1"></i>Local Model
                                </label>
                                <input type="text" class="form-control" id="local_model" name="local_model"
                                       placeholder="llama2, mistral, etc.">
                                <div class="form-text">T√™n model ƒë√£ c√†i ƒë·∫∑t</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Connection -->
        <div class="row">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-vial me-1"></i>Test AI Connection
                        </h6>
                        <p class="card-text text-muted">Ki·ªÉm tra k·∫øt n·ªëi v√† test AI response</p>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="test-prompt" 
                                   placeholder="Nh·∫≠p c√¢u h·ªèi ƒë·ªÉ test AI..." 
                                   value="Xin ch√†o, b·∫°n c√≥ th·ªÉ gi√∫p t√¥i kh√¥ng?">
                            <button type="button" id="test-openrouter" class="btn btn-outline-primary">
                                <i class="fas fa-play me-1"></i>Test AI
                            </button>
                        </div>
                        <div id="test-result" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Model Information -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-secondary">
                    <div class="card-header">
                        <i class="fas fa-info-circle me-1"></i>Th√¥ng tin Models
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success">Free Models (Mi·ªÖn ph√≠)</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-1"></i>Llama 3.1 8B - T·ªët cho chat th√¥ng th∆∞·ªùng</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Phi-3 Mini - Nh·ªè g·ªçn, nhanh</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Gemma 2 9B - C√¢n b·∫±ng t·ªët</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-warning">Paid Models (Tr·∫£ ph√≠)</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-star text-warning me-1"></i>GPT-3.5 Turbo - Nhanh, ch√≠nh x√°c</li>
                                    <li><i class="fas fa-star text-warning me-1"></i>GPT-4 - Ch·∫•t l∆∞·ª£ng cao nh·∫•t</li>
                                    <li><i class="fas fa-star text-warning me-1"></i>Claude 3 Haiku - T·ªët cho vƒÉn b·∫£n</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Help Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-info-circle me-1"></i>H∆∞·ªõng d·∫´n
                </div>
                <div class="card-body">
                    <h6>C√°ch l·∫•y OpenRouter API Key:</h6>
                    <ol>
                        <li>Truy c·∫≠p <a href="https://openrouter.ai" target="_blank">OpenRouter.ai</a></li>
                        <li>ƒêƒÉng k√Ω t√†i kho·∫£n ho·∫∑c ƒëƒÉng nh·∫≠p</li>
                        <li>V√†o <strong>API Keys</strong> trong dashboard</li>
                        <li>Click <strong>Create Key</strong> v√† ƒë·∫∑t t√™n</li>
                        <li>Copy API key v√† paste v√†o tr∆∞·ªùng tr√™n</li>
                    </ol>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>L∆∞u √Ω:</strong> Free models c√≥ gi·ªõi h·∫°n request. Paid models c·∫ßn n·∫°p credit v√†o t√†i kho·∫£n OpenRouter.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // AI Provider switching
    $('#ai_provider').change(function() {
        var selectedProvider = $(this).val();

        // Hide all provider configs
        $('.provider-config').hide();

        // Show selected provider config
        $('#' + selectedProvider + '-config').show();

        // Update form validation
        $('.provider-config input[required]').prop('required', false);
        $('#' + selectedProvider + '-config input[required]').prop('required', true);

        // Update test button
        updateTestButton(selectedProvider);
    });

    function updateTestButton(provider) {
        var $testBtn = $('#test-openrouter');
        var providerNames = {
            'openrouter': 'OpenRouter',
            'openai': 'OpenAI',
            'anthropic': 'Anthropic',
            'google': 'Google AI',
            'grok': 'Grok (X.AI)',
            'deepseek': 'DeepSeek',
            'huggingface': 'HuggingFace',
            'local': 'Local AI'
        };

        $testBtn.html('<i class="fas fa-play me-1"></i>Test ' + providerNames[provider]);
    }

    // Initialize provider on page load
    $('#ai_provider').trigger('change');
    // Test AI connection (works with all providers)
    $('#test-openrouter').click(function() {
        var $btn = $(this);
        var $result = $('#test-result');
        var prompt = $('#test-prompt').val();
        var selectedProvider = $('#ai_provider').val();

        if (!prompt.trim()) {
            $result.html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-1"></i>Vui l√≤ng nh·∫≠p c√¢u h·ªèi ƒë·ªÉ test</div>');
            return;
        }

        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Testing...');
        $result.empty();

        var testData = {
            provider: selectedProvider,
            prompt: prompt
        };

        // Get API key and model based on selected provider
        if (selectedProvider === 'openrouter') {
            testData.api_key = $('#api_key').val();
            testData.model = $('#model').val();
        } else if (selectedProvider === 'openai') {
            testData.api_key = $('#openai_api_key').val();
            testData.model = $('#openai_model').val();
        } else if (selectedProvider === 'anthropic') {
            testData.api_key = $('#anthropic_api_key').val();
            testData.model = $('#anthropic_model').val();
        } else if (selectedProvider === 'google') {
            testData.api_key = $('#google_api_key').val();
            testData.model = $('#google_model').val();
        } else if (selectedProvider === 'grok') {
            testData.api_key = $('#grok_api_key').val();
            testData.model = $('#grok_model').val();
        } else if (selectedProvider === 'deepseek') {
            testData.api_key = $('#deepseek_api_key').val();
            testData.model = $('#deepseek_model').val();
        } else if (selectedProvider === 'huggingface') {
            testData.api_key = $('#huggingface_api_key').val();
            testData.model = $('#huggingface_model').val();
        } else if (selectedProvider === 'local') {
            testData.endpoint = $('#local_endpoint').val();
            testData.model = $('#local_model').val();
        }

        $.ajax({
            url: '/api/test/openrouter',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(testData),
            success: function(response) {
                if (response.status === 'success') {
                    $result.html('<div class="alert alert-success">' +
                               '<i class="fas fa-check me-1"></i><strong>Th√†nh c√¥ng!</strong><br>' +
                               '<strong>AI Response:</strong> ' + response.ai_response + '</div>');
                } else {
                    $result.html('<div class="alert alert-danger"><i class="fas fa-times me-1"></i>' + response.message + '</div>');
                }
            },
            error: function() {
                $result.html('<div class="alert alert-danger"><i class="fas fa-times me-1"></i>L·ªói k·∫øt n·ªëi ƒë·∫øn server</div>');
            },
            complete: function() {
                var providerNames = {
                    'openrouter': 'OpenRouter',
                    'openai': 'OpenAI',
                    'anthropic': 'Anthropic',
                    'google': 'Google AI',
                    'local': 'Local AI'
                };
                $btn.prop('disabled', false).html('<i class="fas fa-play me-1"></i>Test ' + providerNames[selectedProvider]);
            }
        });
    });
    
    // Model selection info
    $('#model').change(function() {
        var selectedModel = $(this).val();
        var isFree = selectedModel.includes(':free');

        if (isFree) {
            $(this).removeClass('border-warning').addClass('border-success');
        } else {
            $(this).removeClass('border-success').addClass('border-warning');
        }
    });

    // Trigger model selection on load
    $('#model').trigger('change');

    // Load dynamic models on page load
    loadDynamicModels();
});

// Dynamic models loading functions
function loadDynamicModels() {
    const $modelSelect = $('#model');
    const $loadBtn = $('button[onclick="loadDynamicModels()"]');
    const currentValue = $modelSelect.val();

    // Show loading state
    if ($loadBtn.length) {
        $loadBtn.html('<i class="fas fa-spinner fa-spin"></i> Loading...').prop('disabled', true);
    }

    $.ajax({
        url: '/api/openrouter/models?categorized=true',
        method: 'GET',
        success: function(data) {
            if (data.status === 'success') {
                populateModelSelect(data.models, currentValue);
            } else {
                console.error('Failed to load models:', data.message);
                showFallbackModels();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading models:', error);
            showFallbackModels();
        },
        complete: function() {
            if ($loadBtn.length) {
                $loadBtn.html('<i class="fas fa-sync-alt"></i> Load Latest').prop('disabled', false);
            }
        }
    });
}

function populateModelSelect(categorizedModels, selectedValue) {
    const $modelSelect = $('#model');
    $modelSelect.empty();

    // Add categories
    const categories = [
        { key: 'free', label: 'üÜì Free Models', icon: 'üÜì' },
        { key: 'openai', label: 'ü§ñ OpenAI Models', icon: 'ü§ñ' },
        { key: 'anthropic', label: 'üß† Anthropic Models', icon: 'üß†' },
        { key: 'google', label: 'üîç Google Models', icon: 'üîç' },
        { key: 'meta', label: 'ü¶ô Meta Llama Models', icon: 'ü¶ô' },
        { key: 'mistral', label: 'üå™Ô∏è Mistral Models', icon: 'üå™Ô∏è' },
        { key: 'cohere', label: 'üåä Cohere Models', icon: 'üåä' },
        { key: 'deepseek', label: 'üî¨ DeepSeek Models', icon: 'üî¨' },
        { key: 'other', label: 'üåü Other Models', icon: 'üåü' }
    ];

    categories.forEach(function(category) {
        const models = categorizedModels[category.key] || [];
        if (models.length > 0) {
            const $optgroup = $('<optgroup>').attr('label', category.label);

            models.forEach(function(model) {
                const $option = $('<option>')
                    .val(model.id)
                    .text(model.display_name)
                    .prop('selected', model.id === selectedValue);
                $optgroup.append($option);
            });

            $modelSelect.append($optgroup);
        }
    });

    // If no models loaded, show fallback
    if ($modelSelect.children().length === 0) {
        showFallbackModels();
    }

    // Trigger change event to update styling
    $modelSelect.trigger('change');
}

function showFallbackModels() {
    const $modelSelect = $('#model');

    // Create fallback options
    $modelSelect.html(`
        <optgroup label="üÜì Free Models (Fallback)">
            <option value="meta-llama/llama-3.1-8b-instruct:free">Llama 3.1 8B Instruct (Free)</option>
            <option value="meta-llama/llama-3.1-70b-instruct:free">Llama 3.1 70B Instruct (Free)</option>
            <option value="microsoft/phi-3-mini-128k-instruct:free">Phi-3 Mini 128K (Free)</option>
            <option value="google/gemma-2-9b-it:free">Gemma 2 9B IT (Free)</option>
            <option value="mistralai/mistral-7b-instruct:free">Mistral 7B Instruct (Free)</option>
        </optgroup>
        <optgroup label="ü§ñ Popular Paid Models">
            <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo ($0.50/$1.50)</option>
            <option value="openai/gpt-4o-mini">GPT-4o Mini ($0.15/$0.60)</option>
            <option value="anthropic/claude-3-haiku">Claude 3 Haiku ($0.25/$1.25)</option>
            <option value="google/gemini-flash-1.5">Gemini 1.5 Flash ($0.075/$0.30)</option>
        </optgroup>
    `);

    // Trigger change event to update styling
    $modelSelect.trigger('change');
}
</script>
